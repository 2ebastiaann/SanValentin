<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>San Valent√≠n üíò</title>

  <!-- Fuente pixel -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#ffe7ef;
      --bg2:#ffd1df;
      --text:#4a2b35;
      --muted:#7a515d;

      --red:#ff2f57;
      --red2:#ff6b88;

      --panel: rgba(255,255,255,.55);
      --panel2: rgba(255,255,255,.65);

      --shadow: 0 18px 45px rgba(255,47,87,.16);
      --btnShadow: 0 14px 30px rgba(255,47,87,.22);

      --radius: 26px;

      /* JS actualiza esto para el viaje del gatito */
      --cat-travel: 420px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      font-family: "Press Start 2P", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(700px 380px at 20% 20%, rgba(255,47,87,.12), transparent 60%),
        radial-gradient(700px 380px at 80% 30%, rgba(255,107,136,.14), transparent 60%),
        linear-gradient(160deg, var(--bg), var(--bg2));
      overflow:hidden;
      padding: 18px;
    }

    body::before{
      content:"";
      position:fixed;
      top:-60px;
      left:-40px;
      right:-40px;
      height:230px;
      background:
        radial-gradient(140px 90px at 10% 70%, rgba(255,255,255,.95), transparent 60%),
        radial-gradient(180px 110px at 28% 55%, rgba(255,255,255,.95), transparent 60%),
        radial-gradient(160px 100px at 48% 70%, rgba(255,255,255,.95), transparent 60%),
        radial-gradient(190px 120px at 70% 55%, rgba(255,255,255,.95), transparent 60%),
        radial-gradient(150px 95px  at 90% 75%, rgba(255,255,255,.95), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }

    .wrap{
      width:min(980px, 96vw);
      text-align:center;
      position:relative;
    }

    .panel{
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.85);
      border-radius: var(--radius);
      padding: 26px 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      position:relative;
      overflow:hidden;
    }

    h1{
      margin: 0 0 10px;
      font-size: clamp(18px, 2.2vw, 28px);
      letter-spacing: .3px;
      line-height: 1.35;
    }

    p{
      margin: 0 0 18px;
      color: var(--muted);
      line-height: 1.6;
      font-size: 11px;
    }

    .stage{ display:none; }
    .stage.active{ display:block; }

    .question{
      font-size: clamp(14px, 1.7vw, 18px);
      margin: 10px 0 16px;
      color: var(--text);
      line-height: 1.45;
    }

    .btnrow{
      display:flex;
      gap: 12px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    button{
      border:none;
      border-radius: 999px;
      padding: 16px 22px;
      font-weight: 800;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      min-width: 160px;
      font-size: 12px;
      font-family: inherit;
      letter-spacing: .2px;
    }
    button:active{ transform: scale(.98); }

    .yes{
      background: linear-gradient(135deg, var(--red), var(--red2));
      color: white;
      box-shadow: var(--btnShadow);
      position:relative;
      z-index: 2;
    }

    .no{
      background: rgba(255,255,255,.92);
      color: var(--text);
      border: 1px solid rgba(255,47,87,.25);
      box-shadow: 0 10px 20px rgba(0,0,0,.06);
      position:relative;
      z-index: 3;
    }

    .tiny{
      margin-top: 14px;
      font-size: 10px;
      color: rgba(122,81,93,.9);
      line-height: 1.6;
    }

    /* === util: para revelar elemento por elemento === */
    .reveal{
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .35s ease, transform .35s ease;
      pointer-events:none;
    }
    .reveal.show{
      opacity: 1;
      transform: translateY(0);
      pointer-events:auto;
    }

    .gif-slot{
      width:min(340px, 88vw);
      height: 200px;
      margin: 12px auto 18px;
      border-radius: 22px;
      background: rgba(255,255,255,.75);
      box-shadow: 0 12px 25px rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .gif-slot small{
      color: rgba(122,81,93,.95);
      padding: 0 14px;
      line-height: 1.6;
      font-size: 10px;
    }

    /* ===== STAGE 3: ARENA ===== */
    .arena{
      width:min(760px, 94vw);
      height: 210px;
      margin: 0 auto;
      position:relative;
      border-radius: 24px;
      background: var(--panel2);
      box-shadow: 0 14px 28px rgba(0,0,0,.06);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.9);
    }
    .arena-inner{
      position:absolute;
      inset:0;
      padding: 18px;
    }

    #valentineYes{
      position:absolute;
      left: 50%;
      top: 42%;
      transform: translate(-50%, -50%) scale(1);
      width: min(520px, 82%);
      height: 110px;
      border-radius: 999px;
      font-size: clamp(16px, 2.4vw, 28px);
    }

    .floating-no{
      position:absolute;
      /* mover inicio un poco hacia el centro-derecha en vez de esquina */
      left: 62%;
      top: 58%;
      transform: translate(-50%, -50%);
      min-width: 170px;
      padding: 16px 20px;
      font-size: 12px;
      background: rgba(255,255,255,.92);
    }

    /* ===== STAGE 4: ESCENA PIXEL ===== */
    .scene{
      width:min(920px, 96vw);
      height: min(560px, 74vh);
      margin: 0 auto;
      position:relative;
      border-radius: 26px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(255,255,255,.88);
      box-shadow: var(--shadow);
      /* padding horizontal para equilibrar margen izquierdo/derecho */
      padding: 18px;
      box-sizing: border-box;
      overflow:hidden;
    }

    .petals{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      opacity: .75;
      pointer-events:none;
      image-rendering: pixelated;
      z-index: 1;
    }

    /* Corazones: encima de p√©talos, debajo de todo */
    .hearts{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      opacity: 0;
      pointer-events:none;
      image-rendering: pixelated;
      z-index: 2;
      transition: opacity .25s ease;
    }

    .branch{
      position:absolute;
      top: 10px;
      left: 10px;
      width: min(230px, 32vw);
      height:auto;
      pointer-events:none;
      image-rendering: pixelated;
      z-index: 3;
    }

    .tree{
      position:absolute;
      top: 0px;
      right: 10px;
      width: min(280px, 38vw);
      height:auto;
      pointer-events:none;
      image-rendering: pixelated;
      z-index: 3;
    }

    .grass{
      position:absolute;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: auto;
      pointer-events:none;
      image-rendering: pixelated;
      z-index: 3;
    }

    .center{
      position:absolute;
      left:50%;
      top:48%;
      transform: translate(-50%, -50%);
      width: min(780px, 92%);
      text-align:center;
      z-index: 4;
      padding: 10px;
    }

    .typed-box{
      width: 100%;
      margin: 0 auto;
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(255,47,87,.10);
      box-shadow: 0 12px 25px rgba(0,0,0,.06);
      border-radius: 22px;
      padding: 18px 16px;
      text-align: center; /* centrar el texto final */
    }

    .typed-title{
      font-size: 12px;
      opacity: .85;
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .typed-text{
      font-size: clamp(12px, 1.7vw, 16px);
      line-height: 1.85;
      min-height: 140px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* ===== Gatito con pausa real =====
       Ciclo: 2.3s ir + 1s pausa + 2.3s volver + 1s pausa = 6.6s
    */
    .cat{
      position:absolute;
      bottom: 34px;
      /* left se calcula y se asigna desde JS (updateCatTravel) */
      left: 24px;
      width: 120px;
      height:auto;
      image-rendering: pixelated;
      z-index: 5;
      pointer-events:none;
      will-change: left, transform;
      /* no animation CSS: movimiento controlado por JS usando left transition
         flip de la imagen se aplica cambiando transform.scaleX SIN transici√≥n
         para evitar efecto espejo visible */
    }

    /* ===== Overlay ramo + bot√≥n ===== */
    .bouquet-overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction: column;
      gap: 14px;
      background: rgba(255,231,239,.72);
      opacity:0;
      pointer-events:none;
      transition: opacity .3s ease;
      z-index:10;
    }
    .bouquet-overlay.show{
      opacity:1;
      pointer-events:auto;
    }

    /* Ramo m√°s peque√±o y controlado */
    .bouquet{
      width: min(260px, 55vw);
      max-height: 58%;
      height:auto;
      image-rendering: pixelated;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.14));
      pointer-events:none;
    }

    .receive-btn{
      border:none;
      border-radius: 999px;
      padding: 14px 22px;
      font-family: inherit;
      font-size: 12px;
      font-weight: 800;
      cursor:pointer;
      background: linear-gradient(135deg, var(--red), var(--red2));
      color: #fff;
      box-shadow: var(--btnShadow);
      z-index: 12;
    }

    /* Mensaje temporal 4s */
    .toast{
      position:absolute;
      left:50%;
      top: 14px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(255,47,87,.12);
      box-shadow: 0 12px 22px rgba(0,0,0,.06);
      border-radius: 999px;
      padding: 12px 16px;
      font-size: 10px;
      line-height: 1.6;
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease;
      z-index: 11;
    }
    .toast.show{ opacity:1; }

    @media (max-width: 520px){
      button{ min-width: 150px; font-size: 11px; }
      #valentineYes{ height: 100px; }
      .scene{ height: min(580px, 78vh); }
      .cat{ width: 105px; bottom: 28px; left: 16px; }
      .bouquet{ width: min(240px, 70vw); }
    }

    
  </style>
</head>

<body>
  <div class="wrap">
    <div class="panel">

      <!-- STAGE 1 -->
      <section class="stage active" id="stage1">
        <h1 class="reveal" id="s1Title"></h1>
        <p class="reveal" id="s1Sub"></p>

        <div class="gif-slot reveal" id="s1Gif">
          <small><b>ESPACIO PARA GIF 1</b><br>(opcional)</small>
        </div>

        <div class="question reveal" id="s1Q"></div>

        <div class="btnrow reveal" id="s1BtnWrap">
          <button class="yes" id="loveYes"></button>
        </div>

        <div class="tiny reveal" id="s1Tiny"></div>
      </section>

      <!-- STAGE 2 -->
      <section class="stage" id="stage2">
        <h1 class="reveal" id="s2Title"></h1>
        <p class="reveal" id="s2Sub"></p>

        <div class="gif-slot reveal" id="s2Gif">
          <small><b>ESPACIO PARA GIF 2</b><br>(opcional)</small>
        </div>

        <div class="tiny reveal" id="s2Tiny"></div>
      </section>

      <!-- STAGE 3 -->
      <section class="stage" id="stage3">
        <h1 class="reveal" id="s3Title"></h1>
        <p class="reveal" id="s3Sub"></p>

        <div class="question reveal" id="s3Q"></div>

        <div class="arena reveal" id="arena">
          <div class="arena-inner">
            <button class="yes" id="valentineYes">S√ç üíó</button>
            <button class="no floating-no" id="valentineNo">No.</button>
          </div>
        </div>

        <div class="tiny reveal" id="hintNo">di que s√≠ por favor üòî</div>
      </section>

      <!-- STAGE 4 -->
      <section class="stage" id="stage4">
        <h1 class="reveal" id="s4Title"></h1>
        <p class="reveal" id="s4Sub"></p>

        <div class="scene reveal" id="scene">
          <img class="petals" src="assets/hojas de cerezo cayendo.gif" alt="petals">
          <img class="hearts" id="hearts" src="assets/corazones cayendo.gif" alt="hearts">

          <img class="branch" src="assets/rama con flores superior.gif" alt="branch">
          <img class="tree" src="assets/arbol de cerezo.gif" alt="tree">
          <img class="grass" src="assets/flores y cesped.gif" alt="grass">

          <img class="cat" id="cat" src="assets/gatito bailando.gif" alt="cat">

          <div class="center">
            <div class="typed-box">
              <div class="typed-title" id="finalTitle"></div>
              <div class="typed-text" id="typedText"></div>
            </div>
          </div>

          <div class="bouquet-overlay" id="bouquetOverlay">
            <img class="bouquet" src="assets/ramo de flores.gif" alt="bouquet">
            <button class="receive-btn" id="receiveBtn">Recibir üéÅ</button>
          </div>

          <div class="toast" id="toast">(eres la mejor, hoy ma√±ana y siempre!)</div>
        </div>

        <div class="tiny reveal" id="s4Tiny"></div>
      </section>

    </div>
  </div>

  <!-- Coloca tu MP3 en assets/ -->
  <audio id="bgMusic" src="assets/we fell in love in october.mp3" preload="auto" loop></audio>

  <script>
    const $ = (s) => document.querySelector(s);
  // Gatito: estado globales (declarados temprano para evitar ReferenceError)
  let _catLoopRunning = false;
  let _catMinLeft = 0;
  let _catMaxLeft = 0;
    // bloquear/ocultar el bot√≥n NO cuando alcance el texto final
    let _noMoveLocked = false;

    // ===== TEXTOS =====
    const TEXTS = {
      s1: {
        title: "Oye... üíó",
        sub: "Resp√≥ndeme esto rapidito...",
        q: "¬øMe amas?",
        btn: "S√≠.",
        tiny: "Aqu√≠ solo existe s√≠."
      },
      s2: {
        title: "Ok ‚úÖ",
        sub: "Eso era todo lo que quer√≠a saber.",
        tiny: "..."
      },
      s3: {
        title: "Era broma üòº",
        sub: "Ahora s√≠ viene lo importante...",
        q: "¬øQuieres ser mi San Valent√≠n? üíò"
      },
      s4: {
        title: "¬°¬°YAAAAA!!üíû",
        sub: "Lee esto con calma...",
        finalTitle: "Preciosa m√≠a",
        tiny: "Con mucho amor, de parte de Juan para Yaya <3"
      }
    };

    // ===== TU MENSAJE FINAL (ed√≠talo aqu√≠) =====
    const FINAL_TEXT = `Gracias por hacerme tan feliz, te amo much√≠simo.

      Siento mucho no poder estar contigo en persona este d√≠a, pero te juro que, de una manera u otra, estar√© presente. Gracias por aceptar ser mi San Valent√≠n, gracias por quererme y amarme tanto, y gracias por quedarte ;)`;

    // ===== TYPEWRITER: lento tipo ‚Äúhumano‚Äù =====
    // Base por letra + pausas extra por espacios y signos.
    function delayForChar(ch){
      // base (m√°s lento)
      let d = 70;

      // pausas extra
      if (ch === " ") d += 220;                    // pausa por palabra
      if ([".", ",", ";", ":"].includes(ch)) d += 350;
      if (["!", "¬°", "?", "¬ø"].includes(ch)) d += 420;
      if (ch === "\n") d += 500;

      // peque√±o ‚Äúrandom‚Äù para que no sea rob√≥tico
      d += Math.floor(Math.random() * 40);
      return d;
    }

    async function typeInto(el, text){
      el.textContent = "";
      for (let i=0; i<text.length; i++){
        el.textContent += text[i];
        await new Promise(r => setTimeout(r, delayForChar(text[i])));
      }
    }

    function showEl(el){
      el.classList.add("show");
    }

    // Render por etapas, elemento por elemento
    async function runStage1(){
      const t = TEXTS.s1;

      const s1Title = $("#s1Title");
      const s1Sub = $("#s1Sub");
      const s1Gif = $("#s1Gif");
      const s1Q = $("#s1Q");
      const loveYes = $("#loveYes");
      const s1BtnWrap = $("#s1BtnWrap");
      const s1Tiny = $("#s1Tiny");

      showEl(s1Title); await typeInto(s1Title, t.title);
      showEl(s1Sub); await typeInto(s1Sub, t.sub);
      // inserta GIF coraz√≥n (tama√±o controlado)
      s1Gif.innerHTML = '<img src="assets/heart.gif" alt="heart" style="max-width:260px;max-height:160px;object-fit:contain;display:block;margin:0 auto;image-rendering:pixelated">';
      showEl(s1Gif);
      showEl(s1Q); await typeInto(s1Q, t.q);
      loveYes.textContent = ""; // typing del bot√≥n tambi√©n
      showEl(s1BtnWrap); await typeInto(loveYes, t.btn);
      showEl(s1Tiny); await typeInto(s1Tiny, t.tiny);
    }

    async function runStage2(){
      const t = TEXTS.s2;

      const s2Title = $("#s2Title");
      const s2Sub = $("#s2Sub");
      const s2Gif = $("#s2Gif");
      const s2Tiny = $("#s2Tiny");

      showEl(s2Title); await typeInto(s2Title, t.title);
      showEl(s2Sub); await typeInto(s2Sub, t.sub);
      // inserta GIF minecraft-fox (tama√±o controlado)
      s2Gif.innerHTML = '<img src="assets/minecraft-fox.gif" alt="fox" style="max-width:260px;max-height:160px;object-fit:contain;display:block;margin:0 auto;image-rendering:pixelated">';
      showEl(s2Gif);
      showEl(s2Tiny); await typeInto(s2Tiny, t.tiny);

      // espera 4s y pasa al stage 3
      setTimeout(() => showStage("stage3"), 4000);
    }

    async function runStage3(){
      const t = TEXTS.s3;

      const s3Title = $("#s3Title");
      const s3Sub = $("#s3Sub");
      const s3Q = $("#s3Q");
      const arena = $("#arena");
      const hintNo = $("#hintNo");

      showEl(s3Title); await typeInto(s3Title, t.title);
      showEl(s3Sub); await typeInto(s3Sub, t.sub);
      showEl(s3Q); await typeInto(s3Q, t.q);
      showEl(arena);
      showEl(hintNo); // ya trae texto, pero lo mantenemos
    }

    async function runStage4(){
      const t = TEXTS.s4;

      const s4Title = $("#s4Title");
      const s4Sub = $("#s4Sub");
      const scene = $("#scene");
      const finalTitle = $("#finalTitle");
      const typedText = $("#typedText");
      const s4Tiny = $("#s4Tiny");

      showEl(s4Title); await typeInto(s4Title, t.title);
      showEl(s4Sub); await typeInto(s4Sub, t.sub);
      showEl(scene);

      // recalcula viaje del gato
      setTimeout(updateCatTravel, 60);
      // inicia el bucle del gatito (usar√° left transitions)
      setTimeout(startCatLoop, 140);

      // iniciar m√∫sica de fondo desde 8s con fade-in
      try { startBgMusic(8, 4000); } catch(e) { /* silencioso */ }

      // escribe titulo y texto
      await typeInto(finalTitle, t.finalTitle);
      await typeInto(typedText, FINAL_TEXT);

      showEl(s4Tiny); await typeInto(s4Tiny, t.tiny);

      // espera 10 segundos y muestra ramo + bot√≥n
      setTimeout(() => {
        $("#bouquetOverlay").classList.add("show");
      }, 10000);
    }

    function resetReveal(stageId){
      // limpia solo elementos reveal dentro del stage
      const stage = $("#" + stageId);
      stage.querySelectorAll(".reveal").forEach(el => el.classList.remove("show"));
      // limpia textos din√°micos
      stage.querySelectorAll("h1, p, .question, .tiny, .typed-title, .typed-text, button").forEach(el => {
        // no borres botones que no son din√°micos
        if (el.id === "valentineYes" || el.id === "valentineNo") return;
        if (el.id === "receiveBtn") return;
        if (el.classList.contains("no") || el.classList.contains("yes")) {
          // botones din√°micos: loveYes
          if (el.id === "loveYes") el.textContent = "";
        }
      });
    }

    // ===== Navegaci√≥n stages =====
    function showStage(id){
      document.querySelectorAll(".stage").forEach(el => el.classList.remove("active"));
      $("#" + id).classList.add("active");

      // resets (para que re-typing funcione si vuelves)
      resetReveal(id);

      // detener bucle del gatito si salimos de stage4
      if (id !== "stage4") stopCatLoop();

      if (id === "stage1") runStage1();
      if (id === "stage2") runStage2();
      if (id === "stage3") runStage3();
      if (id === "stage4") runStage4();
    }

    // ===== Stage 1 inicia =====
    showStage("stage1");

    // ===== Eventos botones =====
    $("#loveYes").addEventListener("click", () => showStage("stage2"));

    // ===== Bot√≥n NO se escapa + S√ç crece hasta cubrir =====
    const arenaEl = $("#arena");
    const btnNo = $("#valentineNo");
    const btnYes = $("#valentineYes");
    const hintNo = $("#hintNo");
    let dodgeCount = 0;

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function moveNoButton(){
      // si est√° bloqueado u oculto, no lo movemos
      if (_noMoveLocked || btnNo.style.display === 'none') return;
      const a = arenaEl.getBoundingClientRect();
      const n = btnNo.getBoundingClientRect();

      const padding = 18;
      const maxX = a.width - n.width - padding;
      const maxY = a.height - n.height - padding;

      const x = Math.random() * maxX + padding/2;
      const y = Math.random() * maxY + padding/2;

      btnNo.style.left = x + "px";
      btnNo.style.top  = y + "px";
      btnNo.style.transform = "none";
    }

    function growYes(){
      dodgeCount++;
      const scale = clamp(1 + dodgeCount * 0.22, 1, 4.2);
      btnYes.style.transform = `translate(-50%, -50%) scale(${scale})`;

      if (dodgeCount === 1) hintNo.textContent = "Uy‚Ä¶ se movi√≥";
      if (dodgeCount === 3) hintNo.textContent = "Ok‚Ä¶ ya entend√≠ ";
      if (dodgeCount === 6) hintNo.textContent = "Ya di que s√≠ por favor";
      if (dodgeCount >= 8) {
        hintNo.textContent = "No hay escapatoria";
        // ocultar el bot√≥n NO permanentemente y bloquear futuros movimientos
        _noMoveLocked = true;
        btnNo.style.display = 'none';
      }
    }

    btnNo.addEventListener("mouseenter", () => { moveNoButton(); growYes(); });
    btnNo.addEventListener("touchstart", (e) => {
      e.preventDefault();
      moveNoButton();
      growYes();
    }, { passive:false });
    btnNo.addEventListener("click", (e) => {
      e.preventDefault();
      moveNoButton();
      growYes();
    });

    btnYes.addEventListener("click", () => showStage("stage4"));

    // ===== Gatito travel =====
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    function updateCatTravel(){
      const scene = $("#scene");
      const cat = $("#cat");
      if(!scene || !cat) return;

      const sceneRect = scene.getBoundingClientRect();
      const catRect = cat.getBoundingClientRect();
      const margin = 34;

      const minLeft = margin;
      const maxLeft = Math.max(minLeft, sceneRect.width - catRect.width - (margin));
      _catMinLeft = Math.round(minLeft);
      _catMaxLeft = Math.round(maxLeft);

      // if cat has no left set yet, place it at the right end
      if (!cat.style.left) {
        cat.style.left = _catMaxLeft + 'px';
        // ensure orientation initial (facing left since at right)
        cat.style.transform = 'scaleX(-1)';
      }
    }
    window.addEventListener("resize", updateCatTravel);

    async function startCatLoop(){
      if (_catLoopRunning) return;
      const cat = $("#cat");
      const scene = $("#scene");
      if (!cat || !scene) return;
      _catLoopRunning = true;

      // ensure travel bounds are updated
      updateCatTravel();

      // compute midpoint
      const mid = Math.round((_catMinLeft + _catMaxLeft)/2);

      // start from right end
      cat.style.transition = 'none';
      cat.style.left = _catMaxLeft + 'px';
      cat.style.transform = 'scaleX(-1)';
      await sleep(50);

      let direction = -1; // -1: move left first; 1: move right first

      while(_catLoopRunning && document.querySelector('#stage4') && document.querySelector('#stage4').classList.contains('active')){
        // for current direction, we move to midpoint then to end
        const targets = direction === -1 ? [mid, _catMinLeft] : [mid, _catMaxLeft];
        for (let t of targets){
          if (!_catLoopRunning) break;
          // set orientation instantly (no transition) before movement
          cat.style.transition = 'none';
          cat.style.transform = direction === -1 ? 'scaleX(-1)' : 'scaleX(1)';
          // small delay to ensure no transform transition
          await sleep(10);
          // move to target in 2.3s
          cat.style.transition = 'left 2.3s linear';
          cat.style.left = t + 'px';
          await sleep(2300);

          // pause 1s
          cat.style.transition = 'none';
          await sleep(1000);
        }

        // invert direction for next cycle
        direction *= -1;
      }
      _catLoopRunning = false;
    }

    function stopCatLoop(){ if (typeof _catLoopRunning !== 'undefined') _catLoopRunning = false; }

    // ===== M√∫sica de fondo: reproducir desde `startSec` con fade-in `fadeMs` ms
    function startBgMusic(startSec = 8, fadeMs = 4000){
      const audio = document.getElementById('bgMusic');
      if (!audio) return;
      // seguridad: si ya est√° reproduciendo, no reiniciamos
      if (!audio.paused) return;
      audio.volume = 0;
      audio.loop = true;

      const playAndFade = () => {
        try{
          // intentar posicionar al segundo requerido
          audio.currentTime = startSec;
        }catch(e){ /* algunos navegadores requieren loadedmetadata */ }
        const p = audio.play();
        if (p && p.catch) p.catch(() => {});

        // fade-in
        const steps = 30;
        const stepTime = Math.max(16, Math.floor(fadeMs / steps));
        let step = 0;
        const iv = setInterval(() => {
          step++;
          audio.volume = Math.min(1, (step / steps));
          if (step >= steps){
            clearInterval(iv);
            audio.volume = 1;
          }
        }, stepTime);
      };

      if (audio.readyState >= 1){
        playAndFade();
      } else {
        audio.addEventListener('loadedmetadata', function once(){
          audio.removeEventListener('loadedmetadata', once);
          try{ audio.currentTime = startSec; } catch(e){}
          playAndFade();
        });
        // asegurar que se cargue
        audio.load();
      }
    }

    // ===== Recibir: corazones + toast 4s =====
    const bouquetOverlay = $("#bouquetOverlay");
    const receiveBtn = $("#receiveBtn");
    const hearts = $("#hearts");
    const toast = $("#toast");

    receiveBtn.addEventListener("click", () => {
      bouquetOverlay.classList.remove("show");

      // Mostrar corazones permanentemente
      hearts.style.opacity = "1";
      hearts.style.pointerEvents = "none";
      toast.classList.add("show");

      // dejamos el toast visible permanentemente
    });

    // Coloca NO en un lugar v√°lido al inicio
    setTimeout(moveNoButton, 200);
  </script>
</body>
</html>
